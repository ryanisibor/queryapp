<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MFA Lookup</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    input, button { padding: 0.5rem; margin: 0.25rem; }
    h1 { margin-bottom: 0.5rem; }
    #results { margin-top: 1.5rem; }
    table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
    th, td { border: 1px solid #ddd; padding: 0.75rem; text-align: left; }
    th { background: #f4f4f4; }
    tr:nth-child(even) { background: #fafafa; }
    .defaultRow { background-color: #e6ffe6 !important; }
    .error { color: #b00020; font-weight: bold; }
    .empty { color: #555; }
    .info-box {
      border: 2px solid #4CAF50;
      background: #f0fff0;
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 8px;
      font-size: 1.2rem;
    }
    .info-box strong {
      color: #2e7d32;
      font-size: 1.3rem;
    }
  </style>
</head>
<body>
  <h1>MFA Lookup Tool</h1>
  <p>Enter a User Principal Name (UPN) to see configured MFA methods.</p>
  
  <input type="text" id="upnInput" placeholder="e.g. user@contoso.com" />
  <button onclick="lookupMfa()">Search</button>
  <button onclick="clearResults()">Clear</button>

  <div id="message"></div>
  <div id="results"></div>

  <script>
    const icons = {
      "Microsoft Authenticator": "üì±",
      "Phone": "üìû",
      "FIDO2 Security Key": "üîë",
      "Windows Hello for Business": "üíª",
      "Software OATH Token": "‚åö",
      "Unknown": "‚ùì"
    };

    // Map Graph raw values to friendlier display names
    function mapFriendlyDefault(raw) {
      switch (raw) {
        case "push": return "Microsoft Authenticator app (push notification)";
        case "microsoftAuthenticator": return "Microsoft Authenticator app";
        case "fido2": return "FIDO2 Security Key";
        case "windowsHelloForBusiness": return "Windows Hello for Business";
        case "mobilePhone": return "Phone (mobile, SMS)";
        case "voiceMobile": return "Phone (mobile, voice call)";
        case "voiceOffice": return "Phone (office, voice call)";
        case "softwareOath": return "Software OATH Token";
        default: return raw;
      }
    }

    async function lookupMfa() {
      const upn = document.getElementById('upnInput').value.trim();
      const resultsDiv = document.getElementById('results');
      const messageDiv = document.getElementById('message');

      resultsDiv.innerHTML = "";
      messageDiv.innerHTML = "";

      if (!upn) {
        messageDiv.innerHTML = "<div class='error'>‚ùå Please enter a UPN.</div>";
        return;
      }

      try {
        const response = await fetch(`/api/mfa-methods?upn=${encodeURIComponent(upn)}`);
        
        if (!response.ok) {
          throw new Error(`Server responded with ${response.status}`);
        }

        const data = await response.json();

        if (data.error) {
          messageDiv.innerHTML = `<div class='error'>‚ùå Error: ${data.error}</div>`;
          return;
        }

        if (!data.methods || data.methods.length === 0) {
          messageDiv.innerHTML = `<div class='empty'>‚ÑπÔ∏è No MFA methods found for <b>${upn}</b>.</div>`;
          return;
        }

        let html = `<h2>MFA Methods for ${data.upn}</h2>`;

        if (data.preferredDefaultFromGraph && data.preferredDefaultFromGraph.raw) {
          const friendlyDefault = mapFriendlyDefault(data.preferredDefaultFromGraph.raw);
          html += `
            <div class="info-box">
              ‚≠ê <strong>Default MFA Method:</strong> ${friendlyDefault}
            </div>
          `;
        }

        html += `
          <table>
            <thead>
              <tr>
                <th>Icon</th>
                <th>Method Type</th>
                <th>Device / Number</th>
              </tr>
            </thead>
            <tbody>
        `;

        data.methods.forEach(m => {
          const icon = icons[m.type] || icons["Unknown"];
          const deviceOrNumber = m.device || m.number || "-";
          const rowClass = m.isDefault ? "defaultRow" : "";

          html += `
            <tr class="${rowClass}">
              <td>${icon}</td>
              <td>${m.type}</td>
              <td>${deviceOrNumber}</td>
            </tr>
          `;
        });

        html += "</tbody></table>";
        resultsDiv.innerHTML = html;

      } catch (err) {
        console.error(err);
        messageDiv.innerHTML = `<div class='error'>‚ùå An error occurred while fetching MFA methods. Details: ${err.message}</div>`;
      }
    }

    function clearResults() {
      document.getElementById('upnInput').value = "";
      document.getElementById('results').innerHTML = "";
      document.getElementById('message').innerHTML = "";
    }
  </script>
</body>
</html>
